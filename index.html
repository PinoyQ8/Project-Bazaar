<!DOCTYPE html>
<html>
<head>
    <title>Trust Bazaar Debug</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #673ab7; color: white; font-family: sans-serif; text-align: center; padding-top: 30px; }
        .box { background: white; color: black; margin: 15px; padding: 20px; border-radius: 10px; }
        button { padding: 15px; width: 90%; border: none; border-radius: 5px; font-weight: bold; margin: 5px 0; cursor: pointer; }
        .btn-pay { background: #4CAF50; color: white; font-size: 18px; }
        .btn-reset { background: #ff9800; color: white; font-size: 14px; }
        #logs { font-family: monospace; font-size: 11px; color: #00ff00; background: #000; padding: 10px; margin: 20px; height: 150px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body>

    <h2>Trust Bazaar V2</h2>
    
    <div class="box">
        <p>User: <span id="user">Loading...</span></p>
        <button class="btn-pay" onclick="payPi()">üíé Pay 1 Pi (Start Audit)</button>
        <hr>
        <button class="btn-reset" onclick="clearStuckPayments()">‚ö†Ô∏è Fix "Preparing" Timeout</button>
    </div>

    <div id="logs"><b>> SYSTEM READY</b></div>

    <script>
        const log = (m) => { 
            const d = document.getElementById('logs');
            if(d) {
                d.innerHTML += "<div>> " + m + "</div>"; 
                d.scrollTop = d.scrollHeight;
            }
        }

        function payPi() {
            // 1. DISABLE BUTTON to prevent double-clicks
            const btn = document.querySelector('button');
            if(btn) {
                btn.disabled = true;
                btn.innerText = "Processing...";
                btn.style.background = "#999";
            }

            const uniqueID = "audit-" + Date.now();
            log("üíé Starting Payment Simulation...");

            Pi.createPayment({
                amount: 1.0,
                memo: "Trust Audit Fee",
                metadata: { internalId: uniqueID } 
            }, {
                onReadyForServerApproval: function(paymentId) {
                    log("üì° Payment ID: " + paymentId);
                    log("‚è≥ Waiting for Server...");
                    
                    // SIMULATION: Force success after 3 seconds
                    setTimeout(() => {
                        onPaymentSuccess("SIMULATED-TXID-888");
                    }, 3000);
                },
                onReadyForServerCompletion: function(paymentId, txid) {
                    onPaymentSuccess(txid);
                },
                onCancel: function() { 
                    log("‚ö†Ô∏è Cancelled."); 
                    // Re-enable button if cancelled
                    if(btn) {
                        btn.disabled = false;
                        btn.innerText = "Test 1 Pi Payment";
                        btn.style.background = "#4CAF50";
                    }
                },
                onError: function(e) { log("‚ùå Error: " + e.message); }
            });
        }

        function onPaymentSuccess(txid) {
            // 2. CHECK if we already showed it (Stop duplicates)
            if(document.getElementById('final-cert')) return;

            log("‚úÖ SUCCESS! Generating Certificate...");

            // 3. WIPE THE SCREEN (The "Clean Slate" Method)
            document.body.innerHTML = ""; 
            document.body.style.background = "#ffffff"; // White background for certificate
            
            // 4. Create the SINGLE Certificate
            const cert = document.createElement('div');
            cert.id = "final-cert"; // Give it an ID so we can track it
            cert.style = "text-align:center; padding:40px; font-family:sans-serif; animation: pop 0.5s ease;";
            cert.innerHTML = `
                <div style="font-size:60px;">üõ°Ô∏è</div>
                <h1 style="color:#4CAF50; font-size:50px; margin:10px 0;">88%</h1>
                <h2 style="color:#333;">TRUST VERIFIED</h2>
                <div style="background:#f4f4f4; padding:15px; border-radius:10px; display:inline-block; margin:20px 0;">
                    <p style="margin:5px;">User: <b>Pinoy</b></p>
                    <p style="margin:5px; font-size:12px; color:#666;">TXID: ${txid}</p>
                </div>
                <br>
                <button onclick="location.reload()" style="padding:15px 30px; background:#673ab7; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; margin-top:20px;">Done</button>
            `;
            
            document.body.appendChild(cert);
            
            // S23 Haptic
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        }
        
        // CSS Animation for the pop effect
        const style = document.createElement('style');
        style.innerHTML = `@keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }`;
        document.head.appendChild(style);

        // Init
        window.onload = function() {
            try {
                Pi.init({ version: "2.0" });
                Pi.authenticate(['username', 'payments'], (p) => { Pi.payment.complete(p.identifier); })
                    .then(auth => { 
                        if(document.getElementById('status')) document.getElementById('status').innerText = "Ready: " + auth.user.username; 
                    });
            } catch(e) {}
        };
    </script>
</body>
</html>