<!DOCTYPE html>
<html>
<head>
    <title>Trust Bazaar Debug</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #673ab7; color: white; font-family: sans-serif; text-align: center; padding-top: 30px; }
        .box { background: white; color: black; margin: 15px; padding: 20px; border-radius: 10px; }
        button { padding: 15px; width: 90%; border: none; border-radius: 5px; font-weight: bold; margin: 5px 0; cursor: pointer; }
        .btn-pay { background: #4CAF50; color: white; font-size: 18px; }
        .btn-reset { background: #ff9800; color: white; font-size: 14px; }
        #logs { font-family: monospace; font-size: 11px; color: #00ff00; background: #000; padding: 10px; margin: 20px; height: 150px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body>

    <h2>Trust Bazaar V2</h2>
    
    <div class="box">
        <p>User: <span id="user">Loading...</span></p>
        <button class="btn-pay" onclick="payPi()">üíé Pay 1 Pi (Start Audit)</button>
        <hr>
        <button class="btn-reset" onclick="clearStuckPayments()">‚ö†Ô∏è Fix "Preparing" Timeout</button>
    </div>

    <div id="logs"><b>> SYSTEM READY</b></div>

    <script>
        // --- 1. THE GATEKEEPER ---
        let auditDone = false; // This variable locks the door after one certificate

        const log = (m) => { 
            const d = document.getElementById('logs');
            if(d) {
                d.innerHTML += "<div>> " + m + "</div>"; 
                d.scrollTop = d.scrollHeight;
            }
        }

        function payPi() {
            // Disable button immediately
            const btn = document.querySelector('button');
            if(btn) {
                btn.disabled = true;
                btn.innerText = "Processing...";
                btn.style.background = "#999";
            }

            const uniqueID = "audit-" + Date.now();
            log("üíé Starting Payment...");

            Pi.createPayment({
                amount: 1.0,
                memo: "Trust Audit Fee",
                metadata: { internalId: uniqueID } 
            }, {
                onReadyForServerApproval: function(paymentId) {
                    log("‚è≥ Waiting for Server...");
                    
                    // SIMULATION: Force success after 3 seconds
                    setTimeout(() => {
                        // Pass a fake ID for the simulation
                        onPaymentSuccess("SIMULATED-888");
                    }, 3000);
                },
                onReadyForServerCompletion: function(paymentId, txid) {
                    // If the real sandbox works, it might trigger this too
                    onPaymentSuccess(txid);
                },
                onCancel: function() { log("‚ö†Ô∏è Cancelled."); },
                onError: function(e) { log("‚ùå Error: " + e.message); }
            });
        }

        function onPaymentSuccess(txid) {
            // --- 2. THE LOCK ---
            // If we have already finished, STOP IMMEDIATELY.
            if(auditDone === true) return; 
            
            // Otherwise, lock the door now.
            auditDone = true; 

            // --- 3. THE WIPE ---
            // Nuke the entire body content instantly
            document.body.innerHTML = ""; 
            document.body.style.background = "#ffffff"; 

            // --- 4. THE SINGLE CERTIFICATE ---
            const cert = document.createElement('div');
            cert.style = "text-align:center; padding:40px; font-family:sans-serif; animation: pop 0.5s ease; max-width: 400px; margin: 0 auto;";
            cert.innerHTML = `
                <div style="font-size:60px; margin-bottom:20px;">üõ°Ô∏è</div>
                <h1 style="color:#4CAF50; font-size:50px; margin:0;">88%</h1>
                <h2 style="color:#333; margin:10px 0;">TRUST VERIFIED</h2>
                <div style="background:#f4f4f4; padding:15px; border-radius:10px; margin:20px 0;">
                    <p style="margin:5px; font-weight:bold;">User: Pinoy</p>
                    <p style="margin:5px; font-size:12px; color:#666;">ID: ${txid}</p>
                </div>
                <button onclick="location.reload()" style="padding:15px 30px; background:#673ab7; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; margin-top:10px;">Done</button>
            `;
            
            document.body.appendChild(cert);
            
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        }

        // Add Animation Style
        const style = document.createElement('style');
        style.innerHTML = `@keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }`;
        document.head.appendChild(style);

        // Standard Init
        window.onload = function() {
            try {
                Pi.init({ version: "2.0" });
                Pi.authenticate(['username', 'payments'], (p) => { Pi.payment.complete(p.identifier); })
                    .then(auth => { if(document.getElementById('status')) document.getElementById('status').innerText = auth.user.username; });
            } catch(e) {}
        };
    </script>
</body>
</html>